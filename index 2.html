<!DOCTYPE html>
<html lang="en">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

	<script src="https://use.fontawesome.com/1ecb03b55d.js"></script>
	<script>
	$('#upload').on('change', function() {
		console.log( 'Started ', Date() );
		$( '#result' ).empty().append( 'Uploading ', $( '<i>' ).addClass( 'fa fa-spinner fa-pulse fa-fw' ) );
		$( '#zips' ).empty();
		$.ajax({
			url: 'ss_to_json.php',
			type: 'POST',
			data: new FormData($('form')[0]),

			// Tell jQuery not to process data or worry about content-type
			cache: false,
			contentType: false,
			processData: false,

			dataType: 'JSON',

			// Custom XMLHttpRequest - for progress bar
			/*
			xhr: function() {
				var myXhr = $.ajaxSettings.xhr();
				if (myXhr.upload) {
					// For handling the progress of the upload
					myXhr.upload.addEventListener('progress', function(e) {
						if (e.lengthComputable) {
							$('progress').attr({
								value: e.loaded,
								max: e.total,
							});
						}
					} , false);
				}
				return myXhr;
			},
			*/
		}).fail( function( f ){
			$( '#result' ).empty().append( f );
		}).done( function( r ) {
			$( 'progress' ).attr({ value: 0 });
			var returns = [];
			console.log( r );
			if( r.status ) {
				$( 'progress' ).attr({ value: 0 });
				var numrows = 0;
				$.each( r.chunks, function( i, chunk ) {
					numrows += Object.keys( chunk.rows ).length;
				});
				console.log( 'numrows', numrows );
				$( '#result' ).empty().append( 'Grabbing Image ' );
				$( '#result' ).append( '<span class="current">0</span>' );
				$( 'progress' ).attr({ max: numrows });
				$.each( r.chunks, function( i, chunk ) {
					console.log( 'chunk', i, chunk );
                    var dataKeys = Object.keys( chunk.rows );
					var promises = [];
                    var chain = $.when();
                    var jKeys = -1, xKeys = -1;
                    
                    for (var x = 0; x < Math.floor(dataKeys.length / 8) + 1; x++) {
                        chain = chain.then(function() {
                            xKeys ++;
                            var yMax = 8;
                            if (xKeys == Math.floor(dataKeys.length / 8))
                                yMax = dataKeys.length % 8;
                            for (var y = 0; y < yMax; y++) {
                                var req = $.ajax({
                                    url: 'grabber.php', 
                                    type: 'GET',
                                    data: chunk.rows[dataKeys[xKeys*8+y]],
                                    dataType: 'JSON',
                                    success: function(r) {
                                        var prog = parseInt( $( 'progress' ).attr( 'value' ) ) + 1;
                                        $( 'progress' ).attr( { value: prog });
                                        $( '.current' ).html( prog );
                                        console.log( r );
                                    }
                                });
                                promises.push(req);
                            }
                            return $.when.apply( null, promises )
                        });
                    }
                    
                    
                    /*for (var j = 0; j < dataKeys.length; j++) {
                        chain = chain.then(function() {
                            jKeys ++;
                            var req = $.ajax({
                                url: 'grabber.php', 
                                type: 'GET',
                                async: false,
                                data: chunk.rows[dataKeys[jKeys]],
                                dataType: 'JSON',
                                success: function(r) {
                                    var prog = parseInt( $( 'progress' ).attr( 'value' ) ) + 1;
                                    $( 'progress' ).attr( { value: prog });
                                    $( '.current' ).html( prog );
                                    console.log( r );
                                }
                            });
                            promises.push(req);
                            return $.when.apply( null, promises )
                        });
                    }*/
					/*$.each( chunk.rows , function( i, row ){
						//console.log( i, row.img );
						var req = $.ajax({
							url: 'grabber.php', 
							type: 'GET',
							data: row,
							dataType: 'JSON'
						}).done( function( r ){
							var prog = parseInt( $( 'progress' ).attr( 'value' ) ) + 1;
							$( 'progress' ).attr( { value: prog });
							$( '.current' ).html( prog );
							console.log( r );
						});
						promises.push( req );
					});*/
					//$.when.apply( null, promises ).done(function p (){ // all ajax requests complete
                    chain.then(function p (){ // all ajax requests complete
						console.log( returns );
						console.log( r );
						console.log( p );
						$( '#zip-status' ).empty().append( 'Creating ZIP file ', $( '<i>' ).addClass( 'fa fa-spinner fa-pulse fa-fw' ) );

						$.ajax({
							async: false,
							url: 'zipper.php',
							type: 'GET',
							data: { dirname: chunk.dirname },
							dataType: 'JSON'
						}).done( function( r ) {
							console.log( r );
							//$( 'progress' ).attr({ max: 1, value: 1 });
							//$( '#result' ).empty();
							$( '#zip-status' ).empty();
							$( '#zips' ).append( $( '<a href="' + r.zip + '"><input type="button" id="download" class="btn btn-primary btn-lg" value="Download"></a>' ) );
							$( '#zips input' ).click( function( e ){
								console.log( 'clicked', e );
								$( e.target ).removeClass( 'btn-primary' );
							});
						}).fail(function() {
							$( '#result' ).empty().append( 'Error: Could not create ZIP file' );
							$( 'progress' ).attr({ max: 1, value: 0 });
						
						});
					});
				});
			} else {
				$( '#result' ).empty().append( r.msg );
			}
		});
	});
	</script>
  </body>
</html>
